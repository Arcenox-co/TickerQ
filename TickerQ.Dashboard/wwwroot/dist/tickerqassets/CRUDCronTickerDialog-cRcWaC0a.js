import{u as pe,t as me,c as P}from"./_plugin-vue_export-helper-CEavA9-_.js";import{u as fe}from"./useCustomForm-CiMEJ6Pp.js";import{c as L}from"./CronTicker-FbHeOXCu.js";import{d as ve,w as U,c as _e,r as z,b as E,e as t,f as a,K as j,g as s,h as _,i as x,u as d,t as q,k as H,l as D,j as I,s as k}from"./index-Byj9w34-.js";import"./index-BXjI2TNL.js";import"./sleep-B8FjgEV9.js";const ge={class:"text-center pa-4"},xe=["innerHTML"],be={key:0},he={key:1},Se=ve({__name:"CRUDCronTickerDialog",props:{dialogProps:{type:Object,required:!0},isOpen:{type:Boolean,required:!0,default:!1}},emits:["close","confirm"],setup(F,{expose:K,emit:G}){const T=pe(),V=me.getRequestData(),Q=L.updateCronTicker(),W=L.addCronTicker(),b=G,r=F;U(()=>r.dialogProps.id,async()=>{await X(),R()});const X=async()=>{await V.requestAsync(r.dialogProps.id,0).then(e=>{const n=w(e.result,!1);n==null?c("requestData",""):c("requestData",n)})},w=(e,n=!1)=>{if(e!=null)try{const i=JSON.stringify(JSON.parse(e),null,2);return n?i.replace(/\n/g,"<br>").replace(/ /g,"&nbsp;"):i}catch{return}},Y=/^(\*|([0-5]?\d)(\/[0-5]?\d)?|(\*\/[0-5]?\d)|([0-5]?\d(-[0-5]?\d)?)(,[0-5]?\d(-[0-5]?\d)?)*)\s+(\*|([0-1]?\d|2[0-3])(\/[0-1]?\d|\/2[0-3])?|(\*\/[0-1]?\d|\/2[0-3])|([0-1]?\d|2[0-3])(-([0-1]?\d|2[0-3]))?(,([0-1]?\d|2[0-3]))*)\s+(\*|([1-9]|[12]\d|3[01])(\/[1-9]|\/[12]\d|\/3[01])?|(\*\/[1-9]|\/[12]\d|\/3[01])|([1-9]|[12]\d|3[01])(-([1-9]|[12]\d|3[01]))?(,([1-9]|[12]\d|3[01]))*)\s+(\*|(1[0-2]|[1-9])(\/(1[0-2]|[1-9]))?|(\*\/(1[0-2]|[1-9]))|(1[0-2]|[1-9])(-([1-9]|1[0-2]))?(,(1[0-2]|[1-9]))*)\s+(\*|([0-6])(\/*[0-6])?|(\*\/[0-6])|([0-6])(-[0-6])?(,[0-6])*)$/,{resetForm:R,handleSubmit:Z,bindField:h,setFieldValue:c,getFieldValue:C,values:f}=fe({initialValues:{exampleData:"",requestData:"",functionName:"",expression:"",description:"",retries:0},validationSchema:e=>({functionName:e.string().required("Function name is required"),expression:e.string().required("Expression is required").matches(Y,"Invalid expression")}),onFieldUpdate:{functionName:(e,n)=>{var i,u;c("exampleData",(i=T.data.find(m=>m.functionName===e))==null?void 0:i.functionRequestType),c("requestData",w((u=V.response.value)==null?void 0:u.result,!1)),n(e)},retries:(e,n)=>{e<o.value.length&&o.value.splice(e),f.retries==o.value.length?y[0].title="Max intervals reached":y[0].title="Select suggested intervals or create one",e<0?n(0):n(e)}},onResetForm:()=>{c("functionName",r.dialogProps.function),c("expression",r.dialogProps.expression),r.dialogProps.isFromDuplicate&&r.dialogProps.id!=null?(c("retries",r.dialogProps.retries),c("description",r.dialogProps.description),r.dialogProps.retryIntervals.forEach(e=>{o.value.push({id:Math.random().toString(36).substring(2)+Date.now().toString(36),title:P(parseInt(e)),value:parseInt(e)})})):r.dialogProps.id!=null&&(r.dialogProps.retryIntervals.forEach(e=>{o.value.push({id:Math.random().toString(36).substring(2)+Date.now().toString(36),title:P(parseInt(e)),value:parseInt(e)})}),c("retries",r.dialogProps.retries),c("description",r.dialogProps.description))},onSubmitForm:async(e,n)=>{if(!n){var i=e.requestData;console.log("init",e.requestData),r.dialogProps.isFromDuplicate?await W.requestAsync({function:e.functionName,expression:e.expression,request:e.requestData,retries:parseInt(`${e.retries}`),description:e.description,intervals:o.value.map(u=>u.value)}).then(()=>{b("close"),b("confirm")}):await Q.requestAsync(r.dialogProps.id,{function:e.functionName,expression:e.expression,request:e.requestData,retries:parseInt(`${e.retries}`),description:e.description,intervals:o.value.map(u=>u.value)}).then(()=>{b("close"),b("confirm")}),V.updateProperty("result",i),R()}}}),ee=_e(()=>{var i,u;const e=C("functionName");if(e==null||e=="")return"Select a function to see the request type";const n=(u=(i=T.data)==null?void 0:i.find(m=>m.functionName==e))==null?void 0:u.functionRequestNamespace;return n==""?"No request data":n}),te=(e,n,i)=>{const u=N=>String(N??"").toLowerCase(),m=u(n);return i.raw.header?!0:u(i.raw.title).includes(m)},y=[{header:!0,title:"Select suggested intervals or create one"},{id:1,title:"1 min",value:60},{id:2,title:"5 min",value:300},{id:3,title:"10 min",value:600}],o=z([]),p=z(null);U(p,()=>{parseInt(p.value)>86400?p.value="86400":parseInt(p.value)<0&&(p.value="0")}),U(o,()=>{if(f.retries==o.value.length?y[0].title="Max intervals reached":y[0].title="Select suggested intervals or create one",f.retries<o.value.length)o.value.pop();else{let e=o.value[o.value.length-1];typeof e=="string"&&(parseInt(e)>86400?e="86400":parseInt(e)<0&&(e="0"),o.value.splice(-1,1,{id:Date.now(),title:P(parseInt(e)),value:parseInt(e)}))}},{deep:!0});const ne=e=>{o.value.splice(e,1)};return K({resetForm:R}),(e,n)=>{const i=s("v-divider"),u=s("v-card-title"),m=s("v-btn"),B=s("v-card-subtitle"),N=s("v-card-item"),ae=s("v-card-text"),O=s("v-card"),$=s("v-container"),v=s("v-col"),se=s("v-alert"),oe=s("v-select"),M=s("v-text-field"),S=s("v-chip"),A=s("v-list-item"),ie=s("v-list-subheader"),re=s("v-combobox"),le=s("v-textarea"),J=s("v-row"),de=s("v-form"),ue=s("v-spacer"),ce=s("v-dialog");return _(),E("div",ge,[t(ce,{modelValue:j(F.isOpen).value,"onUpdate:modelValue":n[4]||(n[4]=l=>j(F.isOpen).value=l),"max-width":"1000",persistent:""},{default:a(()=>[t(O,null,{actions:a(()=>[t(ue),t(m,{color:"grey",onClick:n[3]||(n[3]=l=>b("close"))},{default:a(()=>n[8]||(n[8]=[x(" Close ")])),_:1}),t(m,{color:"orange",onClick:d(Z)},{default:a(()=>[x(q(r.dialogProps.isFromDuplicate?"Create":"Update"),1)]),_:1},8,["onClick"])]),default:a(()=>[t(i),t(J,null,{default:a(()=>[t(v,{cols:"5"},{default:a(()=>[t(u,{class:"py-4"},{default:a(()=>n[5]||(n[5]=[x(" Example Data ")])),_:1}),t(i),t($,null,{default:a(()=>[t(O,{class:"mx-auto my-8",elevation:"16","max-width":"344"},{default:a(()=>[t(N,null,{append:a(()=>[t(m,{icon:"mdi-share-outline",onClick:n[0]||(n[0]=l=>d(c)("requestData",d(C)("exampleData")))})]),default:a(()=>[t(u,null,{default:a(()=>n[6]||(n[6]=[x(" Example Data ")])),_:1}),t(B,null,{default:a(()=>[x(q(ee.value),1)]),_:1}),t(i)]),_:1}),t(ae,null,{default:a(()=>[H("div",{innerHTML:w(d(C)("exampleData"),!0)},null,8,xe)]),_:1})]),_:1})]),_:1})]),_:1}),t(v,{cols:"7"},{default:a(()=>[t(u,{class:"py-4"},{default:a(()=>[x(q(r.dialogProps.isFromDuplicate?"Add New":"Update")+" Cron Ticker ",1)]),_:1}),r.dialogProps.initIdentifier?(_(),D(B,{key:0},{default:a(()=>[t(se,{class:"mb-4",icon:"mdi-alert-circle-outline",color:"warning",text:"This ticker is system-seeded. Changes will reset on app restart."})]),_:1})):I("",!0),t(i),t(de,null,{default:a(()=>[t($,null,{default:a(()=>[t(J,null,{default:a(()=>[t(v,{cols:"6"},{default:a(()=>[t(oe,k(d(h)("functionName"),{"item-title":"functionName","item-value":"functionName",items:d(T).data,variant:"outlined",label:"Functions"}),null,16,["items"])]),_:1}),t(v,{cols:"6"},{default:a(()=>[t(M,k(d(h)("expression"),{variant:"outlined",label:"Expression"}),null,16)]),_:1}),t(v,{cols:"12"},{default:a(()=>[t(M,k(d(h)("description"),{label:"Short description",variant:"outlined"}),null,16)]),_:1}),t(v,{cols:"4"},{default:a(()=>[t(M,k(d(h)("retries"),{type:"number",label:"Retries",variant:"outlined",min:0,max:10}),null,16)]),_:1}),t(v,{cols:"8"},{default:a(()=>[t(re,{"custom-filter":te,modelValue:o.value,"onUpdate:modelValue":n[1]||(n[1]=l=>o.value=l),search:p.value,"onUpdate:search":n[2]||(n[2]=l=>p.value=l),items:y,type:"number",min:0,max:86400,label:d(f).retries==0?"Retries: 0 (no intervals)":o.value.length>=1?"Unset intervals use (default: last set)":"Set intervals or (default: 30s)","item-title":l=>l.title,"item-value":l=>l.id,"hide-selected":"",multiple:"","hide-spin-buttons":"",disabled:d(f).retries==0,hint:`Max intervals (retries): ${d(f).retries}`,"persistent-hint":"",variant:"outlined"},{selection:a(({item:l,index:g})=>[l===Object(l)?(_(),D(S,{key:0,text:l.title,size:"small",variant:"flat",closable:"",label:"","onClick:close":ye=>ne(g)},null,8,["text","onClick:close"])):I("",!0)]),item:a(({props:l,item:g})=>[g.raw.header&&p.value?(_(),D(A,{key:0},{default:a(()=>[o.value.length<d(f).retries?(_(),E("span",be,[t(S,{size:"small",variant:"flat",label:""},{default:a(()=>[x(q(d(P)(parseInt(p.value)))+" "+q(parseInt(p.value)>=86400?"(max value)":""),1)]),_:1}),n[7]||(n[7]=H("span",{class:"ml-3"},"Press enter to add",-1))])):(_(),E("span",he,[t(S,{text:"Max intervals reached",variant:"plain",size:"small",label:""})]))]),_:1})):g.raw.header?(_(),D(ie,{key:1,title:g.title},null,8,["title"])):I("",!0),!g.raw.header&&o.value.length<d(f).retries?(_(),D(A,{key:2,onClick:l.onClick},{default:a(()=>[t(S,{text:g.raw.title,variant:"flat",label:""},null,8,["text"])]),_:2},1032,["onClick"])):I("",!0)]),_:1},8,["modelValue","search","label","item-title","item-value","disabled","hint"])]),_:1}),t(v,{cols:"12"},{default:a(()=>[t(le,k({rows:"10"},d(h)("requestData"),{label:"Request Data",variant:"outlined",disabled:w(d(C)("exampleData"),!1)==null}),null,16,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}});export{Se as default};
