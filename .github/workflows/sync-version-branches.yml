name: Sync Version Branches

on:
  push:
    branches:
      - main
      - net8  # Allows manual pushes to net8 to be visible, but sync logic only runs from main
  workflow_dispatch:
    inputs:
      target_branches:
        description: 'Comma-separated list of target branches (default: net8)'
        required: false
        default: 'net8'
        type: string
      dry_run:
        description: 'Run without making changes'
        required: false
        default: false
        type: boolean

jobs:
  sync-branches:
    runs-on: ubuntu-latest

    permissions:
      contents: write      # Required to push commits to the repository
      pull-requests: write # Required to create pull requests
      issues: write        # Required to create and manage labels

    # Only run sync logic when triggered from main branch (prevents infinite loops)
    if: github.ref == 'refs/heads/main'

    strategy:
      matrix:
        target_branch: ${{ fromJSON(vars.TARGET_BRANCHES || '["net8"]') }}
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract target branches from input
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ -n "${{ github.event.inputs.target_branches }}" ]; then
            echo "TARGET_BRANCHES=[$(echo '${{ github.event.inputs.target_branches }}' | sed 's/,/","/g' | sed 's/^/"/;s/$/"/')]" >> $GITHUB_ENV
          fi

      - name: Check if merge is needed
        id: check_merge
        run: |
          echo "ðŸ” Checking if merge is needed for ${{ matrix.target_branch }}"

          # Check if target branch exists
          if ! git ls-remote --heads origin ${{ matrix.target_branch }} | grep -q ${{ matrix.target_branch }}; then
            echo "branch_exists=false" >> $GITHUB_OUTPUT
            echo "âŒ Target branch ${{ matrix.target_branch }} does not exist"
            exit 0
          fi

          # Check if main has new commits
          git checkout main
          git checkout ${{ matrix.target_branch }}

          if git merge-base --is-ancestor main ${{ matrix.target_branch }}; then
            echo "needs_merge=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No new commits to merge"
          else
            echo "needs_merge=true" >> $GITHUB_OUTPUT
            echo "âœ… New commits found, merge needed"
          fi

      - name: Create sync branch and apply changes
        if: steps.check_merge.outputs.needs_merge == 'true'
        run: |
          echo "ðŸ”„ Creating sync branch from ${{ matrix.target_branch }}"

          # Create a new branch for the PR
          sync_branch="sync-main-to-${{ matrix.target_branch }}-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$sync_branch" ${{ matrix.target_branch }}

          # Get the commits that need to be applied
          commits_to_apply=$(git log "${{ matrix.target_branch }}..main" --oneline --no-merges | cut -d' ' -f1 | tac)

          if [ -n "$commits_to_apply" ]; then
            echo "ðŸ“‹ Applying commits: $commits_to_apply"

            # Cherry-pick each commit individually to avoid merge conflicts
            for commit in $commits_to_apply; do
              echo "ðŸ’ Cherry-picking $commit..."
              if git cherry-pick --no-commit "$commit"; then
                echo "âœ… Cherry-pick successful for $commit"
              else
                echo "âš ï¸  Cherry-pick failed for $commit, skipping..."
                git cherry-pick --abort || true
                git reset --hard HEAD
              fi
            done

            # Reset .csproj files to target branch versions
            echo "ðŸ“ Resetting .csproj files to ${{ matrix.target_branch }} versions..."
            find . -name "*.csproj" -type f -exec git checkout ${{ matrix.target_branch }} -- {} \;

            # Update version and target framework in Directory.Build.props
            dotnet_version=$(echo "${{ matrix.target_branch }}" | sed 's/[^0-9]*//g')
            echo "dotnet_version=$dotnet_version" >> $GITHUB_ENV
            if [ -f "src/Directory.Build.props" ]; then
              echo "ðŸ”„ Updating version and target framework to .NET $dotnet_version..."
              # Update version number (9.0.x â†’ 8.0.x)
              sed -i "s/<Version>9\.0\./<Version>$dotnet_version.0./g" src/Directory.Build.props
              # Update target framework (net9.0 â†’ net8.0)
              sed -i "s/<TargetFramework>net9\.0</<TargetFramework>net$dotnet_version.0</g" src/Directory.Build.props
            fi

            # Stage all changes
            git add -A

            # Check if there are changes to commit
            if git diff --cached --quiet; then
              echo "â„¹ï¸  No changes to commit after processing"
              git checkout main
              git branch -D "$sync_branch"
              exit 0
            fi

            # Commit the changes
            git commit -m "Sync changes from main to ${{ matrix.target_branch }} - Applied recent commits, updated versions & framework, preserved .csproj files"

            echo "ðŸ“¤ Pushing sync branch: $sync_branch"
            git push origin "$sync_branch"

            # Store branch name for PR creation
            echo "sync_branch=$sync_branch" >> $GITHUB_ENV
          else
            echo "â„¹ï¸  No commits to apply"
            git checkout main
            exit 0
          fi

      - name: Ensure labels exist
        if: steps.check_merge.outputs.needs_merge == 'true'
        run: |
          # Create labels if they don't exist (ignore errors if they already exist)
          gh label create "automated" --description "Automated PR" --color "0E8A16" 2>/dev/null || true
          gh label create "sync" --description "Branch synchronization" --color "1D76DB" 2>/dev/null || true
          gh label create "${{ matrix.target_branch }}" --description "Target: ${{ matrix.target_branch }} branch" --color "FEF2C0" 2>/dev/null || true
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        if: steps.check_merge.outputs.needs_merge == 'true' && env.sync_branch != ''
        run: |
          # Create PR using GitHub CLI (gh)
          PR_BODY=$(cat << 'EOF'
          ## ðŸ¤– Automated Branch Sync

          This PR syncs recent changes from `main` branch to `${{ matrix.target_branch }}`.

          ### Changes Applied:
          - âœ… Applied recent commits from main
          - âœ… Updated version numbers (9.0.x â†’ 8.0.x for net8 branch)
          - âœ… Updated target framework (net9.0 â†’ net8.0 for net8 branch)
          - âœ… Preserved .csproj files from ${{ matrix.target_branch }} branch

          ### Review Notes:
          - All .csproj files maintain ${{ matrix.target_branch }} configurations
          - Directory.Build.props has been updated for ${{ matrix.target_branch }} compatibility
          - Ready for testing on ${{ matrix.target_branch }} environment

          ---
          _Created automatically by branch sync workflow_
          EOF
          )

          # Create PR without labels first (they might not exist)
          gh pr create \
            --base "${{ matrix.target_branch }}" \
            --head "${{ env.sync_branch }}" \
            --title "ðŸ”„ Sync main branch changes to ${{ matrix.target_branch }}" \
            --body "$PR_BODY" \
            2>&1 | tee pr_output.txt
          
          # Extract PR number if created
          PR_NUMBER=$(grep -oP '(?<=pull/)\d+' pr_output.txt || echo "")
          
          if [ -n "$PR_NUMBER" ]; then
            echo "âœ… Created PR #$PR_NUMBER"
            
            # Try to add labels if they exist (ignore errors)
            gh pr edit "$PR_NUMBER" --add-label "automated" 2>/dev/null || true
            gh pr edit "$PR_NUMBER" --add-label "sync" 2>/dev/null || true
            gh pr edit "$PR_NUMBER" --add-label "${{ matrix.target_branch }}" 2>/dev/null || true
            
            echo "ðŸ“‹ PR URL: https://github.com/${{ github.repository }}/pull/$PR_NUMBER"
          else
            echo "âš ï¸ PR might already exist or creation failed. Check if a PR already exists for branch: ${{ env.sync_branch }}"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Skip notification
        if: steps.check_merge.outputs.needs_merge == 'false'
        run: echo "â„¹ï¸  No merge needed for ${{ matrix.target_branch }}"

  net8-push-notification:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/net8' && github.actor == 'github-actions[bot]'

    steps:
      - name: Notify about bot push to net8
        run: |
          echo "## ðŸ¤– Bot Push to net8 Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This push to net8 branch was made by github-actions[bot] as part of the automated sync from main." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What happened:" >> $GITHUB_STEP_SUMMARY
          echo "- Changes from main were merged into net8" >> $GITHUB_STEP_SUMMARY
          echo "- Version numbers updated (9.0.x â†’ 8.0.x)" >> $GITHUB_STEP_SUMMARY
          echo "- TargetFramework updated (net9.0 â†’ net8.0)" >> $GITHUB_STEP_SUMMARY
          echo "- .csproj files preserved from net8 branch" >> $GITHUB_STEP_SUMMARY

  summary:
    needs: sync-branches
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: Generate summary
        run: |
          echo "## Branch Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.sync-branches.result }}" = "success" ]; then
            echo "âœ… All branch sync PRs created successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some branch syncs failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Review and merge the created PRs" >> $GITHUB_STEP_SUMMARY
          echo "- Test changes on target branches" >> $GITHUB_STEP_SUMMARY
          echo "- Target branches: net8 (and any others in TARGET_BRANCHES variable)" >> $GITHUB_STEP_SUMMARY